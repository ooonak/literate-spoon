<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>The literate-spoon project</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="css/skeleton.css">
    <link rel="stylesheet" href="css/customize.css">
    <link rel="stylesheet" href="css/github-prettify-theme.css">

    <script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://google-code-prettify.googlecode.com/svn/loader/run_prettify.js"></script>

    <script src="js/site.js"></script>

    <link rel="icon" type="image/png" href="images/favicon.png">
</head>

<body class="code-snippets-visible">

    <div class="container">
        <section class="header">
            <h2 class="title">The literate-spoon project</h2>

            <div class="value-props row">
                <div class="twelve columns value-prop">
                    <img class="value-img" src="images/cpu.svg">
                    Embedded meets the web
                </div>
            </div>

        </section>

        <div class="navbar-spacer"></div>
        <nav class="navbar">
            <div class="container">
                <ul class="navbar-list">
                    <li class="navbar-item"><a class="navbar-link" href="#intro">Intro</a></li>
                    <li class="navbar-item"><a class="navbar-link" href="#connect">Connect</a></li>
                    <li class="navbar-item"><a class="navbar-link" href="#table">Table</a></li>
                    <!--
          <li class="navbar-item">
            <a class="navbar-link" href="#" data-popover="#codeNavPopover">Code</a>
            <div id="codeNavPopover" class="popover">
              <ul class="popover-list">
                <li class="popover-item">
                  <a class="popover-link" href="#grid">Grid</a>
                </li>
                <li class="popover-item">
                  <a class="popover-link" href="#typography">Typography</a>
                </li>
                <li class="popover-item">
                  <a class="popover-link" href="#buttons">Buttons</a>
                </li>
                <li class="popover-item">
                  <a class="popover-link" href="#forms">Forms</a>
                </li>
                <li class="popover-item">
                  <a class="popover-link" href="#lists">Lists</a>
                </li>
                <li class="popover-item">
                  <a class="popover-link" href="#code">Code</a>
                </li>
                <li class="popover-item">
                  <a class="popover-link" href="#tables">Tables</a>
                </li>
                <li class="popover-item">
                  <a class="popover-link" href="#queries">Queries</a>
                </li>
                <li class="popover-item">
                  <a class="popover-link" href="#utilities">Utilities</a>
                </li>
              </ul>
            </div>
          </li>
          -->

                </ul>
            </div>
        </nav>

        <!-- Intro -->
        <div class="docs-section" id="intro">
            <h6 class="docs-header">Intro</h6>
            <div class="row">
                <div class="six columns">
                    <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut
                        labore
                        et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi
                        ut
                        aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
                        cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in
                        culpa qui officia deserunt mollit anim id est laborum.</p>
                </div>
                <div class="six columns">
                    "Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore
                    et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut
                    aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse
                    cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in
                    culpa qui officia deserunt mollit anim id est laborum."
                </div>
            </div>
        </div>

        <!-- Connect -->
        <div class="docs-section" id="connect">
            <h6 class="docs-header">Connect</h6>
            <div class="row">
                <div class="four columns">
                    <img src="images/bluetooth.svg" />
                </div>
                <div class="eight columns">
                    <h4 id="status">Not Connected</h4>
                </div>
            </div>

            <button class="button-primary">Connect</button>
            <!--
            <pre class="code-example">
                <code class="code-example-body prettyprint">
                    int main() {}
                </code>
            </pre>
            -->
        </div>

        <!-- Table -->
        <div class="docs-section" id="table">
            <h6 class="docs-header">Table</h6>

            <div class="docs-example">
                <table class="u-full-width">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Age</th>
                            <th>Sex</th>
                            <th>Location</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Dave Gamache</td>
                            <td>26</td>
                            <td>Male</td>
                            <td>San Francisco</td>
                        </tr>
                        <tr>
                            <td>Dwayne Johnson</td>
                            <td>42</td>
                            <td>Male</td>
                            <td>Hayward</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</body>

</html>

<!-- JavaScript -->
<script>

    const SIMPLE_IO_SERVICE = '13e779a0-bb72-43a4-a748-9781b918258c';
    const SIMPLE_IO_RGB_CHAR = '4332aca6-6d71-4173-9945-6653b6c684a0';
    const SIMPLE_IO_ID_CHAR = 'b749d964-4efb-408a-82ad-7495e8af8d6d';
    const SIMPLE_IO_BUTTON_CHAR = '030de9cf-ce4b-44d0-8aa2-1db9185dc069';

    let rgbCharacteristic = null;
    let statusElement = null;

    const setRGB = (r, g, b) => {
        if (rgbCharacteristic) {
            rgbCharacteristic.writeValueWithoutResponse(new Uint8Array([r, g, b]));
        }
    }

    const hexToRGB = hex => hex.match(/[A-Za-z0-9]{2}/g).map(v => parseInt(v, 16));

    const handleColorPicker = (evt) => {
        const hexcolor = evt.target.value;
        setRGB(...hexToRGB(hexcolor));
    }

    const startButtonNotifications = async (service) => {
        const characteristic = await service.getCharacteristic(SIMPLE_IO_BUTTON_CHAR);
        characteristic.addEventListener('characteristicvaluechanged', (evt) => {
            const value = evt.target.value.getUint8(0);
            console.log(`Button = ${value}`);
            statusElement.innerHTML = `Button ${value === 0 ? "released" : "pressed"}`;
        });
        return characteristic.startNotifications();
    }

    const fetchRGBCharacteristic = async (service) => {
        rgbCharacteristic = await service.getCharacteristic(SIMPLE_IO_RGB_CHAR);
    }

    const openDevice = async (device) => {
        const server = await device.gatt.connect();

        try {
            const service = await server.getPrimaryService(SIMPLE_IO_SERVICE);

            await startButtonNotifications(service);
            await fetchRGBCharacteristic(service);

            console.log('Connected to device', device);
            statusElement.innerHTML = `Connected to ${device.name}`

            device.ongattserverdisconnected = _ => {
                console.log(`Disconnected ${device.id}`);
                statusElement.innerHTML = "Not Connected";
            };
        } catch (err) {
            console.warn(err);
        }
    }

    const scan = async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ services: [SIMPLE_IO_SERVICE] }]
            });

            await openDevice(device);
        } catch (err) {
            // ignore if we didn't get a device
        }
    }

    const init = () => {
        document.querySelector('#connect').addEventListener('click', scan);
        document.querySelector('#colorpicker').addEventListener('input', handleColorPicker);
        statusElement = document.querySelector('#status');

    }

    window.addEventListener('load', init);

</script>